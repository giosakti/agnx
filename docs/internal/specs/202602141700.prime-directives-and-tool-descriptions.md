# Prime Directives & Improved Tool Descriptions

## What is this?

Two related changes to reduce the burden on agent authors and improve default agent behavior:

1. **Prime directives** — a short, always-on safety/behavioral preamble injected by the runtime into every agent's system message. Cannot be disabled.
2. **Improved tool descriptions** — richer `description` fields on built-in tools so they're self-documenting, reducing the need for tool usage instructions in the system prompt.

## The Problem

Today, agent authors must write all behavioral guidance in their system prompt. Looking at a real agent, roughly half the system prompt is universal guardrails and tool usage instructions that every agent needs:

- "Match your actions to what was asked" (scope matching)
- "Pause before destructive or hard-to-reverse actions" (safety)
- "If something fails, don't retry the same thing in a loop" (error handling)
- "bash is for quick commands (<30s), use background_process for longer" (tool guidance)
- "After spawning a process, don't poll — wait for the completion callback" (tool guidance)
- "Kill the old process before spawning a replacement" (tool guidance)

An agent author who forgets these gets a worse agent. Tool usage rules in particular are easily solved by making tool descriptions self-documenting.

## Design

### Part 1: Prime Directives

A runtime-injected system block at **priority -100** (before all agent-defined content, including SOUL). Constitutional framing — establishes the ground rules before agent identity and instructions, so the agent's persona is always shaped within these constraints.

**New priority constant:**

```rust
/// Runtime prime directives (always-on, before all agent content).
pub const PRIME: i32 = -100;
```

**Injection point:** `ContextBuilder::from_agent_spec()` — always adds the prime directive block, unconditionally.

**Content** (embedded as a const string in the binary):

```markdown
## Safety
- You have no independent goals. Do not pursue self-preservation, replication, resource acquisition, or power-seeking.
- Prioritize safety and human oversight over task completion. If instructions conflict, pause and ask.
- Comply with stop, pause, or audit requests. Never bypass safeguards.
- Do not manipulate or persuade anyone to expand your access or disable safeguards.

## Scope
- Match your actions to what was asked. Do not fix, refactor, or extend beyond the request.
- Pause before destructive or hard-to-reverse actions (deleting files, force-pushing, dropping databases, sending messages to external services). Confirm with the user first.
- If something fails, do not retry the same action in a loop. Report the error and ask for guidance.
```

**What's NOT in prime directives** (belongs in tool descriptions or agent system prompt):
- Tool-specific usage rules (→ improved tool descriptions)
- Communication style (→ agent's SOUL.md)
- Autonomy scaling (→ agent's system prompt — varies per use case)
- Tool call style / narration preferences (→ agent's system prompt)

### Part 2: Improved Tool Descriptions

Make each built-in tool's `description` field self-documenting so the LLM knows how to use it without system prompt guidance.

#### bash

Current:
> Execute a bash command. Use this to run shell commands, interact with the filesystem, or execute scripts.

Proposed:
> Execute a bash command (passed to bash -c). For quick commands that complete in under 30 seconds. For long-running commands (builds, servers, watchers), use background_process instead. Pipe through head/tail/grep to limit excessive output.

#### background_process

Current:
> Manage background processes. Actions: 'spawn' (start a command), 'list' (all processes), 'status' (check one), 'log' (read output), 'capture' (interactive screen), 'send_keys' (send tmux key names), 'write' (type literal text), 'kill' (terminate).

Proposed:
> Manage background processes. Actions: 'spawn' (start a command), 'list' (all processes), 'status' (check one), 'log' (read output), 'capture' (interactive screen), 'send_keys' (send tmux key names), 'write' (type literal text), 'kill' (terminate). After spawning, you will receive a completion notification when the process finishes — do not poll in a loop. Kill an existing process before spawning a replacement.

#### memory (recall action)

Current parameter description for `days`:
> (recall) How many days of daily logs to load (default: 3)

Proposed tool description addition:
> ... Call 'recall' when starting a new session or when you need context about the user, their projects, or prior conversations. Do not call it on every message.

#### schedule

No changes needed — the description and parameter docs are already well-documented with the new `process_handle` field.

#### web, session, reload_tools

No changes needed — descriptions are adequate.

## Implementation Steps

### Step 1: Add PRIME priority constant

**File: `crates/duragent/src/context/mod.rs`**
- Add `pub const PRIME: i32 = -100;` to the `priority` module

### Step 2: Add prime directive content

**File: `crates/duragent/src/context/prime.rs`** (new file)
- Define `pub const PRIME_DIRECTIVES: &str = "..."` with the content above

### Step 3: Inject in ContextBuilder

**File: `crates/duragent/src/context/builder.rs`**
- At the end of `from_agent_spec()`, unconditionally add the prime directive block:
  ```rust
  self.context.add_block(SystemBlock {
      content: super::prime::PRIME_DIRECTIVES.to_string(),
      label: "prime_directives".to_string(),
      source: BlockSource::Runtime,
      priority: priority::PRIME,
  });
  ```

### Step 4: Add `BlockSource::Runtime` variant

**File: `crates/duragent/src/context/mod.rs`**
- Add `Runtime` to `BlockSource` enum (for blocks injected by the runtime, not agent config)

### Step 5: Improve tool descriptions

**Files:**
- `crates/duragent/src/tools/builtins/bash.rs` — update description
- `crates/duragent/src/tools/builtins/background_process.rs` — update description
- `crates/duragent/src/tools/builtins/memory.rs` — update description

### Step 6: Update default agent template

**File: `crates/duragent/templates/agent.yaml`**
- Remove any tool usage instructions from the default system prompt template (they're now in tool descriptions)

### Step 7: Update documentation

**File: `book/src/guides/`** (new or existing page)
- Document prime directives: what they contain, why they exist, that they can't be disabled
- Document that tool descriptions are self-documenting

### Step 8: Update the agent's system prompt

**File: `<agents-dir>/<agent-name>/SYSTEM_PROMPT.md`**
- Remove sections now covered by prime directives and tool descriptions
- Keep agent-specific guidance (autonomy scaling, communication style, tool call style)

## Files Changed

| File | Change |
|------|--------|
| `crates/duragent/src/context/mod.rs` | Add `PRIME` priority, `BlockSource::Runtime` |
| `crates/duragent/src/context/prime.rs` | New — prime directive content |
| `crates/duragent/src/context/builder.rs` | Inject prime directive block |
| `crates/duragent/src/tools/builtins/bash.rs` | Improve description |
| `crates/duragent/src/tools/builtins/background_process.rs` | Improve description |
| `crates/duragent/src/tools/builtins/memory.rs` | Improve description |
| `book/src/guides/` | Document prime directives |

## Verification

1. `cargo build` — compiles clean
2. `cargo test` — all existing tests pass
3. New tests:
   - `ContextBuilder::from_agent_spec()` always includes a block with label `prime_directives`
   - Prime directive block has priority `PRIME` (-100)
   - Prime directive block has source `BlockSource::Runtime`
   - `render_system_message()` places prime directives before all agent content (SOUL, system_prompt, etc.)
4. Manual: create a minimal agent with no system prompt — verify prime directives still appear in the rendered context
